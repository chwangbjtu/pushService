{% extends "base.html" %}
{% load myTag static %}

{% block content %}
    <script>
        $(document).ready(function() {
            $('.channel-form').submit(function () {
                //check field value
                var action = $(this).closest('tr').find('#action').val();
                if (action == 'add' || action== 'manual') {
                    var category = $(this).closest('tr').find('#xuan').val();
                    if (category == '') {
                        alert('请选择分类');
                        return false;
                    }
                }
            });

            $("#content_box").val("{{ content }}");
            
            {% for item in search_item %}
            	{% if cond == item.0 %}
            		change_cond_item('{{item.1}}', '{{item.0}}');
            	{% endif %}
            {% endfor %}
            
            {% for item in classifi_item %}
            	{% if classifi == item.0 %}
            		change_classifi_item('{{item.1}}', '{{item.0}}');
            	{% endif %}
            {% endfor %}
            
            {% for item in order_item %}
            	{% if order == item.0 %}
            		change_order_item('{{item.1}}', '{{item.0}}');
            	{% endif %}
            {% endfor %}
            
            {% for item in status_item %}
            	{% if status == item.0 %}
            		change_status_item('{{item.1}}', '{{item.0}}');
            	{% endif %}
            {% endfor %}
        });
    </script>

    <script>
        function change_cond_item(content, val)
        {
            document.getElementById("cond_item").innerHTML=content + " <span class=\"caret\"></span>";
            document.getElementById("cond_box").value = val
        }
        function change_classifi_item(content, val)
        {
            document.getElementById("classifi_item").innerHTML=content + " <span class=\"caret\"></span>";
            document.getElementById("classifi_box").value = val
        }
        function change_order_item(content, val)
        {
            document.getElementById("order_item").innerHTML=content + " <span class=\"caret\"></span>";
            document.getElementById("order_box").value = val
        }
        function change_status_item(content, val)
        {
            document.getElementById("status_item").innerHTML=content + " <span class=\"caret\"></span>";
            document.getElementById("status_box").value = val
        }
        function pageCheck()
        {
            try {
                var x=document.getElementById("page_go").value;
                if(x=="")    throw "值为空";
                if(isNaN(x)) throw "不是数字";
                if(x>{{ page_count }})     throw "页数太大";
                if(x<1)      throw "页数太小";
            }
            catch(err) {
                var y=document.getElementById("err_doc");
                y.innerHTML="错误：" + err + "。";
                event.returnvalue=false;
                return
            }
            var classifi = document.getElementById("classifi_box").value;
            var status = document.getElementById("status_box").value;
            var order = document.getElementById("order_box").value;
            var cond = document.getElementById("cond_box").value;
            var content = document.getElementById("content_box").value;
            location.href = "?page="+x+"&count="+{{count}}+"&order="+order+"&status="+status+"&classifi="+classifi+"&cond="+cond+"&content="+content;
        }
	</script>
			
<div class="container-fluid">		
	<h2 class="text-center">YouTube频道列表</h2>	
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span6">
				<form class='list_form' id='list_form' action="" method="GET">
					<div class="btn-group">
	                    <a class="btn dropdown-toggle" id="order_item" data-toggle="dropdown" href="#">
	                        <span class="caret"></span>
	                    </a>
	                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
	                    	{% for item in order_item %}	                    	
	                    		<li><a tabindex="-1" href="javascript:change_order_item('{{item.1}}', '{{item.0}}')">{{item.1}}</a></li>
	                        {% endfor %}
	                    </ul>
	                </div>
	                <input class="text" id='order_box' style="display:none" name="order" value=""></input>
	                
	                <div class="btn-group">
	                    <a class="btn dropdown-toggle" id="status_item" data-toggle="dropdown" href="#">
	                        <span class="caret"></span>
	                    </a>
	                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
	                    	{% for item in status_item %}	                    	
	                    		<li><a tabindex="-1" href="javascript:change_status_item('{{item.1}}', '{{item.0}}')">{{item.1}}</a></li>
	                        {% endfor %}
	                    </ul>
	                </div>
	                <input class="text" id='status_box' style="display:none" name="status" value=""></input>
	                
	                <div class="btn-group">
	                    <a class="btn dropdown-toggle" id="classifi_item" data-toggle="dropdown" href="#">
	                        <span class="caret"></span>
	                    </a>
	                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
	                    	{% for item in classifi_item %}	                    	
	                    		<li><a tabindex="-1" href="javascript:change_classifi_item('{{item.1}}', '{{item.0}}')">{{item.1}}</a></li>
	                        {% endfor %}
	                    </ul>
	                </div>
	                <input class="text" id='classifi_box' style="display:none" name="classifi" value=""></input>
	                
	           		<button id="filter" type="submit" class="btn btn-primary">确定</button>
           		</form>
			</div>
			<div class="span6">
				<form id='search_form' action="" method="GET">
					<div class="btn-group">
	                    <a class="btn dropdown-toggle" id="cond_item" data-toggle="dropdown" href="#">
	                        <span class="caret"></span>
	                    </a>
	                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
	                    	{% for item in search_item %}	                    	
	                    		<li><a tabindex="-1" href="javascript:change_cond_item('{{item.1}}', '{{item.0}}')">{{item.1}}</a></li>
	                        {% endfor %}
	                    </ul>
	                </div>
	                <input class="text" id='cond_box' style="display:none" name="cond" value=""></input>
	                <input class="text" id='content_box' name="content" value=""></input>
	           		<button id="filter" type="submit" class="btn btn-primary">搜索</button>
           		</form>
			</div>			
		</div>			
	</div>
	
	<div class="container-fluid">	        
        <fieldset>
            <table class="table table-striped table-bordered table-hover table-condensed">
                <thead>
                    <tr>
                        <td width="20%">源频道</td>
                        <td width="35%">简介</td>
                        <td width="10%">播放数</td>
                        <td width="10%">订阅数</td>                        
                        <td width="9%">分类</td>
                        <td width="8%">操作</td>
                        <td width="8%">手动</td>
                    </tr>
                </thead>
                <tbody>
                    {% for data in video_list %}
                        <tr>
                        	<form class="channel-form" method="POST">
	                            <td>
	                            	<input id="border" name="show_id" value="{{ data.show_id }}">
	                            	<a href="{{ data.url }}" target="_blank"><h4>{{data.user_name}}
	                            	<a href="/subscribe/video?cond=owner&content={{ data.show_id}}">
										<img src="{% static 'images/jump.png' %}" style="max-height:26px; max-width:26px;"/>
									</a></h4>
                                </td>
	                            <td>{{data.intro}}</td>
	                            <td>{{data.played}}</td>
	                            <td>
                                    <input type="hidden" id="action" name="action" value=""/>
                                    {{data.fans}}
                                </td>	                            

	                            {% if data.show_id in sub_dict %}
			                        {# 需要找到data.show_id对应的user_name #}
			                        <td>{{ sub_dict|getkey:data.show_id }}</td>
			                        <td>
                                        {% if perms.subscribe.unsubs_youtube %}
									    	<button id="submit" type="submit" class="btn btn-primary" onclick="$(this).closest('tr').find('#action').attr('value', 'cancel');">取消订阅</button>
									    {% else %}	
									    	<button id="submit" type="submit" class="btn" disabled="true">取消订阅(无权限)</button>
									    {% endif %}
                                    </td>
                                    <td>
                                        <input type="hidden" name="url" value="{{ data.url }}"/>
                                        <input type="hidden" name="xuan" value="{{ sub_dict|getkey:data.show_id }}"/>
									    {% if perms.subscribe.manual_youtube %}
									    	<button id="submit" type="submit" class="btn btn-primary" onclick="$(this).closest('tr').find('#action').attr('value', 'manual')">即刻爬虫</button>
									    {% else %}
									    	<button id="submit" type="submit" class="btn" disabled="true">即刻爬虫(无权限)</button>
									    {% endif %}
                                    </td>
								{% else %}
			                        <td>
			                        <select id="xuan" name="xuan">
										{% for item in classifi_item %}
							            	<option value="{{item.0}}">{{item.1}}</option>
							            {% endfor %}						
									</select>
									</td>
                                    <td>
									    {% if perms.subscribe.subs_youtube %}
									    	<button id="submit" type="submit" class="btn btn-primary" onclick="$(this).closest('tr').find('#action').attr('value', 'add');">订阅</button>
									    {% else %}
									    	<button id="submit" type="submit" class="btn" disabled="true">订阅(无权限)</button>
									    {% endif %}
                                    </td>
                                    <td>
                                        <input type="hidden" name="url" value="{{ data.url }}"/>
									    {% if perms.subscribe.manual_youtube %}
									    	<button id="submit" type="submit" class="btn btn-primary" onclick="$(this).closest('tr').find('#action').attr('value', 'manual')">即刻爬虫</button>
									    {% else %}
									    	<button id="submit" type="submit" class="btn" disabled="true">即刻爬虫(无权限)</button>
									    {% endif %}
                                    </td>
								{% endif %}
                        	</form>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
    	</fieldset>

        <div>			
        	<table class="table">
	            <tbody>
	                <tr>
	                    <td>总计<b>{{ video_total }}</b>条, <b>{{ page_count }}</b>页 </td>
	                    <td>
	                        <div>
	                        	第<input class="text span1" id="page_go" name="page" value={{page}} placeholder="几" onkeypress="if(event.keyCode==13||event.which==13){return pageCheck()}">页
	                            <input id="page_subit" type="button" value="转到" class="btn btn-primary" onclick="pageCheck()"></input>
	                            <p id="err_doc"></p>
	                        </div>
	                    </td>
	                </tr>
	            </tbody>
	        </table>
        </div>	
    	
    	<div class="pagination pagination-large">
            <ul>
                {% if page > 1%}
                    <li> <a href="?page=1&count={{count}}&order={{order}}&status={{ status }}&classifi={{classifi}}&cond={{cond}}&content={{content}}">&lt;&lt;</a> </li>
                    <li><a href="?page={{ page|add:-1}}&count={{count}}&order={{order}}&status={{status}}&classifi={{classifi}}&cond={{cond}}&content={{content}}">&lt;</a></li>
                {% else %}
                    <li class="disabled"><a>&lt;&lt;</a> </li>
                    <li class="disabled"><a>&lt;</a> </li>
                {% endif %}

                {% for pg in page_list %}
                    {% if pg == page %}
                        <li><a class="btn btn-success" href="?page={{pg}}&count={{count}}&order={{order}}&status={{status}}&classifi={{classifi}}&cond={{cond}}&content={{content}}">{{pg}}</a></li>
                    {% else %}
                        <li><a href="?page={{pg}}&count={{count}}&order={{order}}&status={{status}}&classifi={{classifi}}&cond={{cond}}&content={{content}}">{{pg}}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page < page_count %}
                    <li><a href="?page={{page|add:1}}&count={{count}}&order={{order}}&status={{status}}&classifi={{classifi}}&cond={{cond}}&content={{content}}">&gt;</a></li>
                    <li><a href="?page={{page_count}}&count={{count}}&order={{order}}&status={{status}}&classifi={{classifi}}&cond={{cond}}&content={{content}}">&gt;&gt;</a></li>
                {% else %}
                    <li class="disabled"><a>&gt;</a></li>
                    <li class="disabled"><a>&gt;&gt;</a></li>
                {% endif %}
            </ul>
        </div>        		        
	</div>				
			
</div>	
{% endblock %}

